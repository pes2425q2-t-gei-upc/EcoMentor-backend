package com.EcoMentor_backend.EcoMentor.Address.useCases.mapper;

import com.EcoMentor_backend.EcoMentor.Address.entity.Address;
import com.EcoMentor_backend.EcoMentor.Address.useCases.dto.AddressDTO;
import com.EcoMentor_backend.EcoMentor.Address.useCases.dto.AddressDTOBestQualification;
import com.EcoMentor_backend.EcoMentor.Address.useCases.dto.AddressDTOSimple;
import com.EcoMentor_backend.EcoMentor.Address.useCases.dto.AddressDTOWithoutCertificate;
import com.EcoMentor_backend.EcoMentor.Address.useCases.dto.CreateAddressDTO;
import com.EcoMentor_backend.EcoMentor.Certificate.entity.Certificate;
import com.EcoMentor_backend.EcoMentor.Certificate.infrastructure.repositories.CertificateRepository;
import com.EcoMentor_backend.EcoMentor.Certificate.useCases.dto.CertificateWithoutForeignEntitiesDTO;
import java.util.List;
import java.util.stream.Collectors;
import org.locationtech.jts.geom.Coordinate;
import org.locationtech.jts.geom.GeometryFactory;
import org.locationtech.jts.geom.Point;
import org.springframework.stereotype.Component;


@Component
public class AddressMapper {
    private final CertificateRepository certificateRepository;
    private final GeometryFactory geometryFactory = new GeometryFactory();


    public AddressMapper(CertificateRepository certificateRepository) {
        this.certificateRepository = certificateRepository;
    }

    // Entity to DTO conversion. The id field is included in the DTO.
    public AddressDTO toDTO(Address address) {
        if (address == null) {
            return null;
        }
        return AddressDTO.builder()
                .addressId(address.getAddressId())
                .addressName(address.getAddressName())
                .addressNumber(address.getAddressNumber())
                .zipcode(address.getZipcode())
                .town(address.getTown())
                .region(address.getRegion())
                .province(address.getProvince())
                .longitude((float) address.getLocation().getX())
                .latitude((float) address.getLocation().getY())
                .certificates(address.getCertificates().stream()
                        .map(this::certificateWfeToDto)
                        .collect(Collectors.toList()))
                .build();
    }

    public AddressDTOSimple toDTOSimple(Address address) {
        if (address == null) {
            return null;
        }
        return AddressDTOSimple.builder()
                .addressId(address.getAddressId())
                .addressName(address.getAddressName())
                .addressNumber(address.getAddressNumber())
                .zipcode(address.getZipcode())
                .town(address.getTown())
                .region(address.getRegion())
                .province(address.getProvince())
                .longitude((float) address.getLocation().getX())
                .latitude((float) address.getLocation().getY())
                .certificates(address.getCertificates().stream()
                        .map(Certificate::getCertificateId)
                        .collect(Collectors.toList()))
                .build();
    }




    // CreateDTO to Entity. CreateDTO does not have an id field because it is generated by the database.
    public Address toEntity(CreateAddressDTO dto) {
        if (dto == null) {
            return null;
        }
        Point location = geometryFactory.createPoint(new Coordinate(dto.getLongitude(), dto.getLatitude()));
        List<Certificate> certificates = dto.getCertificates().stream()
                .map(certificateRepository::findCertificateByCertificateId)
                .collect(Collectors.toList());

        return Address.builder()
                .addressName(dto.getAddressName())
                .addressNumber(dto.getAddressNumber())
                .zipcode(dto.getZipcode())
                .town(dto.getTown())
                .region(dto.getRegion())
                .province(dto.getProvince())
                .location(location)
                .certificates(certificates)
                .build();
    }


    public CertificateWithoutForeignEntitiesDTO certificateWfeToDto(Certificate certificate) {
        if (certificate == null) {
            return null;
        }
        return CertificateWithoutForeignEntitiesDTO.builder()
                .certificateId(certificate.getCertificateId())
                .certificateType(certificate.getCertificateType())
                .build();
    }


    public AddressDTOWithoutCertificate toDTOWithoutCertificate(Address address) {
        if (address == null) {
            return null;
        }
        return AddressDTOWithoutCertificate.builder()
                .addressId(address.getAddressId())
                .addressName(address.getAddressName())
                .addressNumber(address.getAddressNumber())
                .zipcode(address.getZipcode())
                .town(address.getTown())
                .region(address.getRegion())
                .province(address.getProvince())
                .longitude((float) address.getLocation().getX())
                .latitude((float) address.getLocation().getY())
                .build();
    }


    public AddressDTOBestQualification toDTOWithBestQualification(Address address) {
        if (address == null) {
            return null;
        }
        return AddressDTOBestQualification.builder()
                .addressName(address.getAddressName())
                .addressNumber(address.getAddressNumber())
                .zipcode(address.getZipcode())
                .town(address.getTown())
                .longitude((float) address.getLocation().getX())
                .latitude((float) address.getLocation().getY())
                .build();
    }



}